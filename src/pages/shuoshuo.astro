---
import MainGridLayout from "../layouts/MainGridLayout.astro";
---

<MainGridLayout title="说说" description="碎碎念与即刻记录">
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-4 py-4 md:px-6 md:py-5 relative w-full">
      <div class="relative max-w-4xl mx-auto">
        <!-- 页面头部 -->
        <div class="moments-header mb-6">
          <div class="header-content">
            <div class="header-info">
              <h1 class="moments-title text-xl md:text-2xl lg:text-3xl font-bold text-90 mb-1">📢 说说</h1>
              <p class="moments-subtitle text-sm md:text-base lg:text-lg text-75">记录一些灵感与碎语</p>
            </div>
          </div>
        </div>

        <!-- 说说容器 -->
        <div class="moments-timeline">
          <div id="my-shouts-container" class="timeline-list space-y-4"></div>
        </div>

        <!-- 底部提示 -->
        <div class="moments-tips text-center mt-6 md:mt-8 lg:mt-10 text-75 text-xs md:text-sm lg:text-base italic">
          Powered by Qexo
        </div>
      </div>
    </div>
  </div>

  <!-- 外部资源 -->
  <link rel="stylesheet" href="https://cdn.cbd.int/kemiaofxjun-cdn@1.0.3/css/qexo-talk/talk.css" />

  <!-- 修复后的初始化脚本 -->
<script>
  // 修复核心：处理Astro页面导航的初始化问题
  function loadTalkScript() {
    // 如果脚本已加载，直接初始化
    if (window.myQexoShouts) {
      initQexo();
      return;
    }
    
    // 创建脚本标签
    const script = document.createElement('script');
    script.src = "https://cdn.cbd.int/kemiaofxjun-cdn@1.0.3/js/qexo-talk/talk.js";
    script.defer = true;
    
    // 成功加载后初始化
    script.onload = () => {
      if (typeof myQexoShouts !== "undefined") {
        initQexo();
      } else {
        console.error("talk.js 加载失败");
      }
    };
    
    // 加载失败处理
    script.onerror = () => {
      console.error("无法加载说说脚本");
    };
    
    document.head.appendChild(script);
  }

  // 初始化函数（增加DOM元素检查）
  function initQexo() {
    // 确保容器元素已经存在
    const container = document.getElementById('my-shouts-container');
    if (!container) {
      // 稍后重试（针对导航场景）
      setTimeout(initQexo, 50);
      return;
    }
    
    // 清空容器防止重复内容
    container.innerHTML = '';
    
    // 初始化说说
    myQexoShouts.init({
      el: "#my-shouts-container",
      avatar: "https://img.314926.xyz/images/2025/08/13/no-background-kemiaofxjun.webp",
      name: "克喵爱吃卤面",
      limit: 10,
      baseURL: "https://qexo.kemeow.top",
    }).catch(err => {
      console.error("初始化失败:", err);
    });
  }

  // 首次加载和Astro导航事件处理
  if (document.readyState === 'complete') {
    loadTalkScript();
  } else {
    window.addEventListener('load', loadTalkScript);
  }
  
  // 监听Astro页面导航事件
  document.addEventListener('astro:page-load', () => {
    // 增加延时确保DOM完全更新
    setTimeout(loadTalkScript, 100);
  });
</script>
</MainGridLayout>